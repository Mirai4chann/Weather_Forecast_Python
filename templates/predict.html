<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Predict</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fade-in { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }
    .animate-fade-in { animation: fade-in .35s ease-out; }

    /* layout + palette */
    html,body,#root { height: 100%; margin: 0; background: #0f172a; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    /* Increase base font scale for better legibility */
    :root { --base-font: 18px; } /* bumped up */
    body { font-size: var(--base-font); }

    /* Scale up common Tailwind text utilities (override to make everything larger) */
    .text-xs  { font-size: 1.0rem !important; }    /* 16px */
    .text-sm  { font-size: 1.15rem !important; }   /* 18.4px */
    .text-base{ font-size: 1.25rem !important; }   /* 20px */
    .text-lg  { font-size: 1.4rem !important; }    /* 22.4px */
    .text-xl  { font-size: 1.7rem !important; }    /* 27.2px */
    .text-2xl { font-size: 2.0rem !important; }    /* 32px */
    .text-3xl { font-size: 2.5rem !important; }    /* 40px */
    .text-4xl { font-size: 3.2rem !important; }    /* 51.2px */
    .text-5xl { font-size: 4.0rem !important; }    /* 64px */

    /* Card defaults */
    .card { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06); color: #e6eef8; }

    /* Day card tweaks - larger emoji and temps */
    .day-card .text-2xl { font-size: 2.8rem !important; }   /* emoji/icon bigger */
    .day-card .text-white { font-size: 1.9rem !important; } /* avg temp bigger */

    /* Suggestion box sizing */
    .card .suggestion { font-size: 1.05rem; line-height:1.3; }

    /* Sparkline & layout - taller for readability */
    .sparkline { width: 100%; height: 110px; display: block; }
    .day-card { min-width: 140px; max-width: 190px; flex: 0 0 auto; padding: 1rem; }

    /* Maintain comfortable line-height */
    .card p, .card div { line-height: 1.3; }

    /* Keep spacing balanced on larger screens */
    @media (min-width: 1280px) {
      .sparkline { height: 140px; }
      .day-card { min-width: 160px; max-width: 220px; }
    }

    /* small fixes */
    .cards-row { gap: 12px; padding-bottom: 6px; }
    .top-row { gap: 16px; align-items: start; }
    .stats-col { min-width: 92px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  {% raw %}
  <script type="text/babel">
    const { useState, useEffect } = React;

    function PredictApp(){
      const [prediction, setPrediction] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [city, setCity] = useState('');

      useEffect(()=>{
        const params = new URLSearchParams(window.location.search);
        const cityParam = params.get('city');
        if(cityParam){
          setCity(cityParam);
          fetchPrediction(cityParam);
        }
      },[]);

      async function fetchPrediction(cityName){
        setLoading(true);
        setError('');
        setPrediction(null);
        try{
          const res = await fetch('/predict-weather', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ city: cityName, days: 7 })
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.error || 'Failed to fetch');
          setPrediction(data);
        }catch(e){
          setError('Network error. Please try again.');
        }finally{
          setLoading(false);
        }
      }

      function emojiFor(cond){
        if(!cond) return 'üå§Ô∏è';
        const c = cond.toLowerCase();
        if(c.includes('rain')) return 'üåßÔ∏è';
        if(c.includes('cloud')) return '‚òÅÔ∏è';
        if(c.includes('clear')||c.includes('sun')) return '‚òÄÔ∏è';
        if(c.includes('snow')) return '‚ùÑÔ∏è';
        if(c.includes('thunder')) return '‚õàÔ∏è';
        if(c.includes('fog')) return 'üå´Ô∏è';
        return 'üå§Ô∏è';
      }

      // normalized sparkline points (0..100 x, 0..30 y)
      function buildSparklinePoints(forecast){
        if(!forecast || !forecast.length) return '';
        const temps = forecast.map(d => Number(d.avg_temp) || 0);
        const min = Math.min(...temps);
        const max = Math.max(...temps);
        const range = Math.max(1, max - min);
        const w = 100;
        const h = 30;
        return temps.map((t,i)=>{
          const x = (temps.length === 1) ? 50 : (i/(temps.length-1)) * w;
          const y = h - ((t - min)/range) * h;
          return `${x},${y}`;
        }).join(' ');
      }

      const highest = prediction && prediction.forecast && prediction.forecast.length
        ? Math.max(...prediction.forecast.map(f=>Number(f.max_temp) || -999))
        : null;
      const lowest = prediction && prediction.forecast && prediction.forecast.length
        ? Math.min(...prediction.forecast.map(f=>Number(f.min_temp) || 999))
        : null;

      // suggestions for selected day (index 0 = today) ‚Äî richer, more detailed tips
      function suggestionsFor(day){
        const out = [];
        const t = Number(day.avg_temp) || 0;
        const max = Number(day.max_temp) || t;
        const min = Number(day.min_temp) || t;
        const cond = (day.condition || '').toLowerCase();

        // Condition-based advice
        if (/rain|shower|drizzle|thunder/.test(cond)) {
          out.push('‚òî Bring an umbrella and wear waterproof shoes ‚Äî pockets and electronics can get wet.');
        } else if (/snow|sleet/.test(cond)) {
          out.push('‚ùÑÔ∏è Snow expected: allow extra travel time, wear warm waterproof boots and traction on shoes.');
        } else if (/clear|sunny/.test(cond) && max >= 28) {
          out.push('‚òÄÔ∏è Sunny & hot: apply sunscreen (SPF 30+), wear a hat and stay hydrated.');
        } else if (/cloud|overcast/.test(cond)) {
          out.push('‚òÅÔ∏è Overcast: comfortable for outdoor activities; bring a light layer for cooler mornings/evenings.');
        } else if (/fog|mist/.test(cond)) {
          out.push('üå´Ô∏è Low visibility: drive carefully, use lights and avoid long runs in heavy fog.');
        }

        // Temperature-based advice
        if (t >= 30) {
          out.push('üíß High temps: avoid strenuous activity midday and drink plenty of water.');
        } else if (t >= 20) {
          out.push('üå§Ô∏è Warm: ideal for outdoor plans ‚Äî carry a light layer for mornings.');
        } else if (t >= 10) {
          out.push('üß• Cool: wear a mid-layer and consider a light jacket for evening.');
        } else {
          out.push('üßä Cold: dress in layers, wear a coat, hat and gloves; watch for icy surfaces if wet.');
        }

        // Laundry / chores guidance
        if (!/rain|snow|drizzle|sleet|thunder/.test(cond) && max >= 18) {
          out.push('üß∫ Good day to dry laundry outside ‚Äî sunny/windy conditions will help clothes dry quickly.');
        } else if (/rain|snow|drizzle|sleet/.test(cond)) {
          out.push('üö´ Not ideal for outdoor drying ‚Äî use indoor drying or a dryer.');
        }

        // Travel / event caution
        if (/thunder|storm|wind/.test(cond) || (max - min) > 12) {
          out.push('‚ö†Ô∏è Weather may change quickly ‚Äî check updates before long trips or outdoor events.');
        }

        // Return top 4 suggestions for clarity
        return out.slice(0, 4);
      }

      // choose today's index (0) by default, allow selecting card
      const [selectedIndex, setSelectedIndex] = useState(0);
      useEffect(()=> { if(prediction && prediction.forecast) setSelectedIndex(0); }, [prediction]);

      return (
        <div className="fixed inset-0 flex items-center justify-center p-4" style={{background: 'linear-gradient(180deg,#0b1220 0%, #2b1055 100%)'}}>
          <div className="w-full max-w-6xl h-[calc(100vh-3rem)]">
            <div className="card rounded-3xl p-6 h-full flex flex-col overflow-hidden shadow-2xl">
              {/* header row */}
              <div className="flex top-row mb-3 items-start">
                 <div className="flex-1">
                   <div className="flex items-center gap-3">
                     <h2 className="text-2xl md:text-3xl font-bold text-white">üîÆ Forecast</h2>
                     <div className="text-sm text-gray-300">{prediction ? `${prediction.city}, ${prediction.country}` : ''}</div>
                   </div>
                   <p className="text-xs text-gray-400 mt-1">Hourly & multi-day trend ‚Äî clean, balanced layout</p>
                 </div>

                <div className="flex items-center gap-3">
                  {/* Close / Return button */}
                  <button
                    onClick={() => {
                      // try to focus opener and close this tab if possible, fallback to navigating to /
                      try {
                        if (window.opener && !window.opener.closed) {
                          window.opener.focus();
                        }
                        window.close();
                        // some browsers block close() for manually opened tabs, fall back:
                        setTimeout(() => { if (!window.closed) window.location.href = '/'; }, 200);
                      } catch (e) {
                        window.location.href = '/';
                      }
                    }}
                    className="bg-white/6 hover:bg-white/8 text-white rounded-full px-3 py-1 text-sm border border-white/10 transition"
                    title="Close and return to Weather App"
                  >
                    ‚Üê Back
                  </button>

                  <div className="text-right">
                   {prediction && prediction.forecast && prediction.forecast.length>0 ? (
                     <div>
                       <div className="text-4xl md:text-5xl font-extrabold text-white">
                         {prediction.forecast[selectedIndex].avg_temp}¬∞
                       </div>
                       <div className="text-sm text-gray-300">
                         {emojiFor(prediction.forecast[selectedIndex].condition)} {prediction.forecast[selectedIndex].condition}
                       </div>
                     </div>
                   ) : null}
                  </div>
                </div>
               </div>

              {/* sparkline + compact stats */}
              <div className="flex mb-4 gap-4">
                <div className="flex-1 card rounded-2xl p-3">
                  <div className="text-xs text-gray-300 mb-2">Temperature trend</div>
                  <svg viewBox="0 0 100 30" className="sparkline" preserveAspectRatio="none">
                    <defs>
                      <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stopColor="#06b6d4" stopOpacity="0.22" />
                        <stop offset="100%" stopColor="#7c3aed" stopOpacity="0.03" />
                      </linearGradient>
                    </defs>

                    {prediction && prediction.forecast ? (()=> {
                      const pts = buildSparklinePoints(prediction.forecast);
                      if(!pts) return null;
                      const closed = `${pts} 100,30 0,30`;
                      return (
                        <g>
                          <polyline points={pts} fill="none" stroke="#60a5fa" strokeWidth="0.9" strokeLinejoin="round" strokeLinecap="round" />
                          <polygon points={closed} fill="url(#g1)"/>
                        </g>
                      );
                    })() : null}
                  </svg>

                  <div className="flex justify-between text-xs text-gray-400 mt-2">
                    {prediction && prediction.forecast ? prediction.forecast.map((d,i)=>(
                      <div key={i} className="truncate text-center" style={{minWidth:0, flex:1}}>{d.date.split(',')[0]}</div>
                    )) : <div className="text-gray-500">No data</div>}
                  </div>
                </div>

                <div className="stats-col flex flex-col gap-2">
                  <div className="card rounded-xl p-2 text-center">
                    <div className="text-xs text-gray-400">High</div>
                    <div className="text-lg font-semibold text-white">{highest !== null ? `${highest}¬∞` : '‚Äî'}</div>
                  </div>
                  <div className="card rounded-xl p-2 text-center">
                    <div className="text-xs text-gray-400">Low</div>
                    <div className="text-lg font-semibold text-white">{lowest !== null ? `${lowest}¬∞` : '‚Äî'}</div>
                  </div>
                </div>
              </div>

              {/* horizontally scrollable day cards */}
              <div className="flex-1 flex flex-col overflow-hidden">
                <div className="overflow-x-auto">
                  <div className="flex cards-row py-2">
                    {prediction && prediction.forecast ? prediction.forecast.map((d, idx) => (
                      <button
                        key={idx}
                        onClick={() => setSelectedIndex(idx)}
                        className={`day-card card rounded-2xl p-3 flex mb-5 mt-5 ml-3 flex-col items-center justify-between transition-shadow ${selectedIndex===idx ? 'ring-2 ring-cyan-400/30' : 'hover:shadow-lg hover:shadow-cyan-500/10'}`}
                        aria-pressed={selectedIndex === idx}
                        aria-label={`Select ${d.date}`}
                      >
                        <div className="text-sm text-gray-300">{d.date.split(',')[0]}</div>
                        <div className="text-2xl mt-2">{emojiFor(d.condition)}</div>
                        <div className="text-white font-bold text-lg mt-2">{d.avg_temp}¬∞</div>
                        <div className="w-full flex justify-between text-xs text-gray-300 mt-3">
                          <div>‚¨ÜÔ∏è {d.max_temp}¬∞</div>
                          <div>‚¨áÔ∏è {d.min_temp}¬∞</div>
                        </div>
                      </button>
                    )) : (
                      <div className="text-gray-400 px-3">No forecast</div>
                    )}
                  </div>
                </div>

                {/* suggestions panel for selected day */}
                <div className="mt-3 card rounded-2xl p-4 flex-shrink-0">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-gray-400">Suggestions for</div>
                      <div className="text-sm font-semibold text-white mt-1">
                        {prediction && prediction.forecast ? `${prediction.forecast[selectedIndex].date.split(',')[0]} ‚Ä¢ ${prediction.city}` : '‚Äî'}
                      </div>
                    </div>
                    <div className="text-2xl">{prediction && prediction.forecast ? emojiFor(prediction.forecast[selectedIndex].condition) : 'üí°'}</div>
                  </div>

                  <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                    {prediction && prediction.forecast ? suggestionsFor(prediction.forecast[selectedIndex]).map((s, i) => (
                      <div key={i} className="bg-white/4 rounded-md p-2 text-sm text-gray-200">
                        {s}
                      </div>
                    )) : (
                      <div className="text-gray-400">No suggestions</div>
                    )}
                  </div>
                </div>

                <div className="text-xs text-gray-400 mt-3 text-center">Data: OpenWeatherMap ‚Ä¢ Visualized</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<PredictApp />);
  </script>
  {% endraw %}
</body>
</html>